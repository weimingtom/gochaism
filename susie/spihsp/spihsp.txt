* spihsp (based on UNDPM32 library)

失踪していたUNDPM32のソースコードを発掘！記念にSusieプラグインに乗せました！
視聴者全員サービスで今昔恥ずかしソースコードもプレゼント！な、何の罰ゲーム！？

プラグインはaxdpm.spiとaxdpmex.spiの2種類入っています。後者はexeを読み込めます。
SusieプラグインとUNDPM32の相性もあって、展開などに要する時間は大きめです。
ちょっとしたゲームのデータ展開くらいなら十分だとは思いますが、わかりません。
ホストにもよりますが、exe対応版を常用するのは負担が大きいかもしれません。

再配布は自由ですが、その際はバイナリとともにソースコードを添付してください。
改造などは大歓迎です。その際は事後で構わないので教えてくださるとうれしいです。
現行のプラグインでは実行ファイル全体からデータを探索していますが、検索対象となる
セクションを限るとそれなりに無駄が減ると思われます（プラグインの仕様上難しい？）。

パッカーで実行ファイルが圧縮されている場合、プラグインはDPMにたどり着けません。
この場合、DPM領域を取り除いた実行ファイルをパッカーにかけ、展開されたデータの
末尾にDPMを復元、HSPHEDにあるDPMのオフセットを書き換えるという作業が必要です。
少し内部データの形式に関する知識がいりますが、決して難しい作業ではないです。

gocha <http://gocha.s151.xrea.com/>

** HSP3.3対応について

axdpm33.spiとaxdpmex33.spiがHSP3.3対応版です。（旧バージョンには対応しない）
内部構造上、一つのプラグインで新旧バージョンに対応することが現状困難なため、
新旧で別プラグインの扱いにしています。対象に応じて使い分けてください。

ソースコード上は HSP33_SUPPORT の定義の有無によって処理を分けています。
新旧による暗号化ルーチンの差は、じつはさほど大きくありません。

** おまけについて

※下記のHSP3.3対応版はありません

Susieプラグインでは展開速度がしゃれにならない可能性を考えて、過去に制作した
hspdivというプログラムを同梱してあります。UNDPM32のインタフェースに合った方法で
展開を行うので、ファイル数の多いアーカイブでも安心かと思われます。

また、総当たりで暗号解読を行うDpmAttackというサンプルを入れておきました。
こちらはDPMアーカイブを処理するのではなく、そこから切り出された暗号を処理するので、
常用するには不便ですが、複雑な要素なしに暗号を解いてくれるので、ある意味では最強です。

** DPMファイルのフォーマットほか

全体的な構造は至ってシンプルです。暗号化のルーチンもシンプルです。では何が複雑なのか。

DPMファイルを復号する際、単体であればアーカイブのファイル情報に書かれている暗号鍵を
復号ルーチンで使う鍵に変換してデータの復号を行います。ところが、実行ファイルに
内包されている場合、アーカイブとは別に暗号鍵が格納されている領域があるのです。
つまり、ただ実行ファイルからアーカイブをリッピングして展開するのは無理なのです。

一体どこにどういった情報が詰められているのか。このあたりは説明が面倒なので、
プラグインのソースから読み取って欲しいと思います。拙作のプラグインは2.55や
実行ファイルの暗号化を一元化して扱うために、読み込み時にアーカイブの持つ
鍵を改変しているので理解しづらいかとは思いますが（作者も覚えていない）。

また、実行ファイルのチェックサムに関しては下記にまとめました。
http://d.hatena.ne.jp/GOCHA/20060212/hsp3checksum
